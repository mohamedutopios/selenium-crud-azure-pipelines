trigger:
  - main
  - develop

pool:
  vmImage: ubuntu-latest

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'

stages:
- stage: BuildAndTest
  displayName: Build & Selenium Tests
  jobs:
  - job: SeleniumTests
    displayName: Selenium End-to-End Tests
    steps:

    # ==========================================
    # 1) Checkout
    # ==========================================
    - checkout: self
      displayName: Checkout source code

    # ==========================================
    # 2) Install Chromium + Chromedriver
    # ==========================================
    - script: |
        sudo apt-get update
        sudo apt-get install -y chromium chromium-chromedriver
        chromium --version
        chromedriver --version
      displayName: Install Chromium & Chromedriver

    # ==========================================
    # 3) Prepare Maven cache
    # ==========================================
    - script: |
        mkdir -p $(MAVEN_CACHE_FOLDER)
      displayName: Prepare Maven cache folder

    - task: Cache@2
      displayName: Cache Maven dependencies
      inputs:
        key: 'maven | "$(Agent.OS)" | **/pom.xml'
        path: $(MAVEN_CACHE_FOLDER)

    # ==========================================
    # 4) Build (sans tests)
    # ==========================================
    - task: Maven@3
      displayName: Maven Clean Package
      inputs:
        mavenPomFile: pom.xml
        goals: clean package
        options: '-DskipTests $(MAVEN_OPTS)'
        jdkVersionOption: '1.17'

    # ==========================================
    # 5) Selenium Tests
    # ==========================================
    - task: Maven@3
      displayName: Run Selenium Tests
      inputs:
        mavenPomFile: pom.xml
        goals: test
        options: '$(MAVEN_OPTS)'
        jdkVersionOption: '1.17'
      env:
        CI: 'true'

    # ==========================================
    # 6) Generate HTML reports
    # ==========================================
    - script: |
        mvn surefire-report:report
        mvn allure:report
      displayName: Generate HTML Reports
      condition: always()

    # ==========================================
    # 7) Publish JUnit results
    # ==========================================
    - task: PublishTestResults@2
      displayName: Publish JUnit Results
      condition: always()
      inputs:
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        testRunTitle: Selenium E2E Tests

    # ==========================================
    # 8) Publish HTML reports
    # ==========================================
    - task: PublishBuildArtifacts@1
      displayName: Publish Surefire HTML Report
      condition: always()
      inputs:
        PathtoPublish: target/site
        ArtifactName: surefire-html-report

    - task: PublishBuildArtifacts@1
      displayName: Publish Allure HTML Report
      condition: always()
      inputs:
        PathtoPublish: target/allure-report
        ArtifactName: allure-html-report

    # ==========================================
    # 9) Publish screenshots (si pr√©sents)
    # ==========================================
    - task: PublishBuildArtifacts@1
      displayName: Publish Selenium Screenshots
      condition: always()
      inputs:
        PathtoPublish: target/screenshots
        ArtifactName: selenium-screenshots
